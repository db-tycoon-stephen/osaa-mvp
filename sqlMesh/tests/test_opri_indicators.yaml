# SQLMesh tests for OPRI indicators model
# Tests data quality, schema, and transformations

test_opri_indicators_not_null:
  model: sources.opri
  description: Test that critical columns are not null
  inputs:
    opri.data_national:
      rows:
        - indicator_id: "OPRI_001"
          country_id: "NGA"
          year: 2020
          value: 45.0
          magnitude: ""
          qualifier: ""
        - indicator_id: "OPRI_002"
          country_id: "ETH"
          year: 2021
          value: 52.3
          magnitude: ""
          qualifier: ""
    opri.label:
      rows:
        - indicator_id: "OPRI_001"
          indicator_label_en: "Peace index"
        - indicator_id: "OPRI_002"
          indicator_label_en: "Conflict index"
  outputs:
    query: |
      SELECT
        COUNT(*) as total_rows,
        COUNT(indicator_id) as non_null_indicator,
        COUNT(country_id) as non_null_country,
        COUNT(year) as non_null_year
      FROM sources.opri
    rows:
      - total_rows: 2
        non_null_indicator: 2
        non_null_country: 2
        non_null_year: 2

test_opri_indicators_unique_grain:
  model: sources.opri
  description: Test that grain (indicator_id, country_id, year) is unique
  inputs:
    opri.data_national:
      rows:
        - indicator_id: "OPRI_001"
          country_id: "NGA"
          year: 2020
          value: 45.0
          magnitude: ""
          qualifier: ""
        - indicator_id: "OPRI_001"
          country_id: "NGA"
          year: 2021
          value: 46.0
          magnitude: ""
          qualifier: ""
        - indicator_id: "OPRI_001"
          country_id: "ETH"
          year: 2020
          value: 50.0
          magnitude: ""
          qualifier: ""
    opri.label:
      rows:
        - indicator_id: "OPRI_001"
          indicator_label_en: "Peace index"
  outputs:
    query: |
      SELECT
        indicator_id,
        country_id,
        year,
        COUNT(*) as row_count
      FROM sources.opri
      GROUP BY indicator_id, country_id, year
      HAVING COUNT(*) > 1
    rows: []

test_opri_indicators_join_preserves_rows:
  model: sources.opri
  description: Test that left join with labels preserves all data rows
  inputs:
    opri.data_national:
      rows:
        - indicator_id: "OPRI_001"
          country_id: "NGA"
          year: 2020
          value: 45.0
          magnitude: ""
          qualifier: ""
        - indicator_id: "OPRI_002"
          country_id: "ETH"
          year: 2020
          value: 52.3
          magnitude: ""
          qualifier: ""
    opri.label:
      rows:
        - indicator_id: "OPRI_001"
          indicator_label_en: "Peace index"
        - indicator_id: "OPRI_002"
          indicator_label_en: "Conflict index"
  outputs:
    query: |
      SELECT COUNT(*) as row_count
      FROM sources.opri
    rows:
      - row_count: 2

test_opri_indicators_column_rename:
  model: sources.opri
  description: Test that indicator_label_en is renamed to indicator_description
  inputs:
    opri.data_national:
      rows:
        - indicator_id: "OPRI_001"
          country_id: "NGA"
          year: 2020
          value: 45.0
          magnitude: ""
          qualifier: ""
    opri.label:
      rows:
        - indicator_id: "OPRI_001"
          indicator_label_en: "Peace and security index"
  outputs:
    query: |
      SELECT indicator_description
      FROM sources.opri
      WHERE indicator_id = 'OPRI_001'
    rows:
      - indicator_description: "Peace and security index"

test_opri_indicators_row_count:
  model: sources.opri
  description: Test row count matches input data
  inputs:
    opri.data_national:
      rows:
        - indicator_id: "OPRI_001"
          country_id: "NGA"
          year: 2020
          value: 45.0
          magnitude: ""
          qualifier: ""
        - indicator_id: "OPRI_002"
          country_id: "ETH"
          year: 2020
          value: 52.3
          magnitude: ""
          qualifier: ""
        - indicator_id: "OPRI_003"
          country_id: "KEN"
          year: 2020
          value: 38.5
          magnitude: ""
          qualifier: ""
    opri.label:
      rows:
        - indicator_id: "OPRI_001"
          indicator_label_en: "Index 1"
        - indicator_id: "OPRI_002"
          indicator_label_en: "Index 2"
        - indicator_id: "OPRI_003"
          indicator_label_en: "Index 3"
  outputs:
    query: |
      SELECT COUNT(*) as row_count
      FROM sources.opri
    rows:
      - row_count: 3